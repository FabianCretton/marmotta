<!--
Web interface to manage Data Views

Author: Fabian Cretton - OverLOD Project - HES-SO Valais
 
-->
<html>
<head>
<!--###BEGIN_HEAD###-->
    <title>Data Views</title>
    <script type="text/javascript" src="../../webjars/jquery/1.8.2/jquery.min.js"></script>
    <script type="text/javascript" src="../../webjars/marmotta.js"></script>
    <script type="text/javascript" src="js/widgets/dataViewList.js"></script>
    <script type="text/javascript" src="js/widgets/dataViewClient.js"></script>
    <script type="text/javascript">
			function showViewDetails(viewName)
			{
				// Display the view name
				$("#dataViewName").html("Data view name: " + viewName);

				// Display the view's query 
				$.get("../query?viewName=" + viewName, function(data) {
						$("#dataViewQuery").html("Data view query:<BR>" + data);
				}).error(function(jqXhr, textStatus, error) {
						// textStatus just contains 'error'
						alert("ERROR getting Data Views query (" + jqXhr.statusText + ": " + jqXhr.responseText + ")");
						$("#dataViewQuery").html("Data view query:<BR>ERROR getting Data Views query (" + jqXhr.statusText + ": " + jqXhr.responseText + ")");
				});		
				
			}
		
				var listEditor = null ; // object that would be needed for a "refresh list" button, see EDS as an example
        $(document).ready(function(){
						listEditor = new DVList("DataViews_div",_SERVER_URL);
						
						displayDVCallExamples("DataViewCalls_div",_SERVER_URL) ;
        })
				
				function displayDVCallExamples(id,host)
				{
				var loader =$("<img style='position: relative;top: 4px;margin-left: 10px;' src='../public/img/loader/ajax-loader_small.gif'>");
				
				var container = $("#"+id);
				
				// for debugging WS
				var dataViewClient = new DataView(host) ;
				
				container.append($("<h2></h2>").append("Data View - calls examples").append(loader));
				
				//container.append($("<p></p>").append("JSON")) ;

				container.append($("<a class='data_view_text_link'></a>").text("Test WS - getDataView call JSON: allTriplesLimit10").click(function(){
					dataViewClient.getDataView('allTriplesLimit10', null, "application/sparql-results+json", successJSON, failure) ;
				 }));

				//container.append($("<p></p>").append("SPARQL-XML")) ;

				container.append($("<BR><a class='data_view_text_link'></a>").text("Test WS - getDataView call XML: allTriplesLimit10").click(function(){
					dataViewClient.getDataView('allTriplesLimit10', null, "application/sparql-results+xml", successXML, failure) ;
				 }));

				//container.append($("<p></p>").append("SPARQL-CSV")) ;

				container.append($("<BR><a class='data_view_text_link'></a>").text("Test WS - getDataView call CSV: allTriplesLimit10").click(function(){
					dataViewClient.getDataView('allTriplesLimit10', null,"text/csv", success, failure) ;
				 }));

 				//container.append($("<p></p>").append("SPARQL with parameters")) ;

				container.append($("<BR><a class='data_view_text_link'></a>").text("Test WS - getDataView with parameters: UC_allValuesOneAreaOneYear_params(Ayent - 2002)").click(function(){
						var queryParams = {p_areaURI:encodeURIComponent("http://dbpedia.org/resource/Ayent"), p_year:"2002"};

						dataViewClient.getDataView('UC_allValuesOneAreaOneYear_params', queryParams,"text/csv", success, failure) ;
				 }));

 				//container.append($("<p></p>").append("Create new Data View")) ;

				container.append($("<BR><a class='data_view_text_link'></a>").text("Test WS - New data view LIMIT 2").click(function(){
					dataViewClient.addDataView('newTest', 'SELECT * WHERE {?s ?p ?o} LIMIT 2', success, failure) ;
				 }));

 				//container.append($("<p></p>").append("Update 'newTest' Data View")) ;

				container.append($("<BR><a class='data_view_text_link'></a>").text("Test WS - Update 'newTest' Data View LIMIT 3").click(function(){
					dataViewClient.updateDataView('newTest', 'SELECT * WHERE {?s ?p ?o} LIMIT 3', success, failure) ;
				 }));

 				container.append($("<BR><a class='data_view_text_link'></a>").text("Test WS - Delete 'newTest' Data View").click(function(){
					dataViewClient.deleteDataView('newTest', success, failure) ;
				 }));

				 loader.hide() ;

				function success(result)
				{
				alert('success: ' + result) ;
				document.getElementById("queryResult").innerHTML= result; 
				}

				// ici reçu en text
				function successXML(resultXML)
				{
				document.getElementById("queryResult").innerHTML= resultXML ; 
				}
			
				// ici l'objet JSON reçu en text
				function successJSON(resultJSON)
				{
				// alert('success:' + resultJSON) ;
			
				// Getting directly the results bindings:
				var resParsed = JSON.parse(resultJSON).results.bindings ;

				document.getElementById("queryResult").innerHTML= JSON.stringify(resParsed, null); 
				}
				
				function failure(jqXhr)
				{
				//alert('error (' + serverError.name + '): ' + serverError.message) ;
					alert("Server call ERROR (" + jqXhr.statusText + ": " + jqXhr.responseText + ")");
				}
			}
				</script>
				<style>
						.data_view_text_link {
								padding: 2px;
								cursor: pointer;
						}
						.importer_table {
								background-color: #eeeeee;
								padding: 10px;
								border: 1px solid gray;
								-webkit-border-radius: 3px;
								border-radius: 3px;
						}				 
				}

    </style>
<!--###END_HEAD###-->
</head>
<body>
<!--###BEGIN_CONTENT###-->
<h1>Data views</h1>
	<div id="DataViews_div"></div>
	<h2>Data view details</h2>
  <div id="dataViewName">Data view name:</div>  
  <div id="dataViewQuery">Data view query:</div>  
	<div id="DataViewCalls_div"></div>
  <p>Query result:</p>  
  <div id="queryResult"></div> 
<!--###END_CONTENT###-->
</body>
</html>
